name: Kong DP Build & Deploy

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Which environment?"
        required: true
        type: choice
        options:
          - dev2
          - prod
      image_tag_input:
        description: "Optional: Provide an existing image tag to deploy. Leave empty to build a new image."
        required: false
        type: string

jobs:

  build_image:
    # Run only if no image tag was supplied
    if: ${{ github.event.inputs.image_tag_input == '' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env }}
    env:
      KONG_VERSION: ${{ vars.KONG_VERSION }}

    outputs:
      image_tag: ${{ steps.set_tag.outputs.image_tag }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_AR_HOST }} --quiet

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Kong Golden Image
        run: |
          IMAGE="${{ secrets.GCP_AR_HOST }}/${{ secrets.GCP_PROJECT }}/kong-dp"
          TAG="${KONG_VERSION}-$(date +'%Y%m%d-%H%M%S')"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

          docker buildx build \
            --platform linux/amd64 \
            -t "$IMAGE:$TAG" \
            -t "$IMAGE:latest" \
            --push \
            ./infra_config

      - name: Set image tag output
        id: set_tag
        run: echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

  deploy_dps:
    runs-on: ubuntu-latest
    needs: [build_image]
    environment: ${{ github.event.inputs.env }}

    # Always run (even when build_image is skipped)
    permissions:
      contents: read
      id-token: write

    env:
      IMAGE_TAG: ${{ github.event.inputs.image_tag_input != '' && github.event.inputs.image_tag_input || needs.build_image.outputs.image_tag }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_LOCATION }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Deploy Kong Primary DP
        run: |
          IMAGE="${{ secrets.GCP_AR_HOST }}/${{ secrets.GCP_PROJECT }}/kong-dp"
          echo "Deploying DP1 using image tag: $IMAGE_TAG"

          helm upgrade \
            kong-primary kong/kong \
            -n kong \
            --skip-crds --values infra_config/gke_dp_primary.yml \
            --set image.repository="$IMAGE" \
            --set image.tag="$IMAGE_TAG" \
            --install

      - name: Deploy Kong Standby DP
        run: |
          IMAGE="${{ secrets.GCP_AR_HOST }}/${{ secrets.GCP_PROJECT }}/kong-dp"
          echo "Deploying DP2 using image tag: $IMAGE_TAG"

          helm upgrade \
            kong-standby kong/kong \
            -n kong \
            --skip-crds --values infra_config/gke_dp_standby.yml \
            --set image.repository="$IMAGE" \
            --set image.tag="$IMAGE_TAG" \
            --install
